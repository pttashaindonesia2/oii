<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>Absensi Face ID</title>
  <script src="https://cdn.tailwindcss.com"></script>
    <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #1e3a8a, #3b82f6); /* gradasi biru gelap */
      font-family: 'Segoe UI', sans-serif;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .app-container {
      width: 100%;
      max-width: 420px;
      height: 100%;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    table {
      font-size: 0.9rem;
    }
    th, td {
      word-break: break-word;
      text-align: center;
    }
    td img {
      max-height: 48px;
      max-width: 48px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .nav-bar {
      display: flex;
      justify-content: space-around;
      padding: 12px;
      background: linear-gradient(to right, #1e3a8a, #2563eb); /* gradasi biru */
      border-top: 2px solid #3b82f6;
      position: sticky;
      bottom: 0;
    }
    .nav-btn {
      flex: 1;
      text-align: center;
      margin: 0 5px;
      padding: 10px;
      font-weight: bold;
      border-radius: 12px;
      transition: 0.3s;
    }
    .nav-btn:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen">
  <div class="bg-white p-4 rounded-2xl shadow-2xl w-full max-w-sm mx-auto">
    <h1 class="text-2xl font-bold text-center text-blue-700 mb-1">üì≤ Absensi Face ID</h1>
    <p class="text-blue-500 text-center text-sm mb-3">Gunakan kamera depan untuk absensi</p>

    <!-- Pilih Nama -->
    <select id="nama-anak" class="border border-blue-400 p-2 rounded-lg w-full mt-2 shadow-sm focus:ring-2 focus:ring-blue-500">
      <option value="">-- Pilih Nama --</option>
      <option>AHMAD WIRANTO (TPM)</option>
      <option>CANDRA ADI PURNA (TIPK)</option>
      <option>DAHLIA SUAIDA NUR AMALINA (RPL)</option>
      <option>ELVIRA AISYAH KIRANI (RPL)</option>
      <option>HABIB (TITL)</option>
      <option>HANDIKA PRATAMA (TITL)</option>
      <option>JOKO ANDIKA (TPM)</option>
      <option>NUN NAJIB SAPUTRA (TIPK)</option>
    </select>

    <!-- Tombol Scan -->
    <button id="scan-button" class="w-full bg-blue-600 text-white font-semibold rounded-lg px-4 py-2 mt-3 hover:bg-blue-700">
      üì∑ Mulai Scan Wajah
    </button>

    <!-- Tombol Capture -->
    <button id="capture-button" class="w-full bg-green-600 text-white font-semibold rounded-lg px-4 py-2 mt-2 hidden hover:bg-green-700">
      ‚úÖ Ambil Gambar
    </button>
    
    <p id="status-message" class="text-center mt-2 font-semibold text-sm"></p>

    <!-- Kamera -->
    <div class="mt-3 rounded-xl overflow-hidden bg-blue-100 border border-blue-300">
      <video id="camera-feed" autoplay></video>
      <canvas id="capture-canvas" class="hidden"></canvas>
    </div>

    <!-- Tombol Riwayat -->
    <a href="riwayat.html" class="block w-full bg-blue-500 text-white text-center font-semibold rounded-lg px-4 py-2 mt-3 hover:bg-blue-600">
      üìë Lihat Riwayat
    </a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqnNGO9ko0nlht3ljrqVGuYm7TaIbN6yo",
      authDomain: "sample-firebase-ai-app-f1543.firebaseapp.com",
      projectId: "sample-firebase-ai-app-f1543",
      storageBucket: "sample-firebase-ai-app-f1543.firebasestorage.app",
      messagingSenderId: "432850053606",
      appId: "1:432850053606:web:943f5b4e2af9889c374e27"
    };

    let db, auth, video, canvas, context;

    const main = async () => {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      await signInAnonymously(auth);

      video = document.getElementById("camera-feed");
      canvas = document.getElementById("capture-canvas");
      context = canvas.getContext("2d");

      const scanButton = document.getElementById("scan-button");
      const captureButton = document.getElementById("capture-button");
      const statusMessageEl = document.getElementById("status-message");
      const namaSelect = document.getElementById("nama-anak");

      scanButton.addEventListener("click", () => {
        if (video.srcObject && video.srcObject.active) {
          stopCamera();
          scanButton.textContent = "üì∑ Mulai Scan Wajah";
          captureButton.style.display = "none";
          statusMessageEl.textContent = "Scan dihentikan.";
          statusMessageEl.className = "text-gray-500 font-semibold mt-2";
        } else {
          startCamera();
          scanButton.textContent = "‚õî Hentikan Scan";
          captureButton.style.display = "block";
        }
      });

      captureButton.addEventListener("click", async () => {
        const namaDipilih = namaSelect.value;
        if (!namaDipilih) {
          statusMessageEl.textContent = "Silakan pilih nama terlebih dahulu.";
          statusMessageEl.className = "text-red-500 font-semibold mt-2";
          return;
        }

        const now = new Date();
        const jam = now.getHours();
        const menit = now.getMinutes();
        let status = "Hadir";

        if (jam < 7 || (jam === 7 && menit <= 35)) status = "Hadir";
        else if ((jam === 7 && menit > 35) || (jam > 7 && jam < 15) || (jam === 15 && menit < 30)) status = "Terlambat";
        else if (jam > 15 || (jam === 15 && menit >= 30)) status = "Pulang";

        const dataUrl = takePicture();
        const lokasi = await getLocation();
        await submitAttendance(dataUrl, namaDipilih, lokasi, status);
      });

      async function getLocation() {
        return new Promise((resolve) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              try {
                const response = await fetch(
                  `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
                );
                const data = await response.json();
                resolve(data.display_name || `${lat.toFixed(6)}, ${lon.toFixed(6)}`);
              } catch (e) {
                resolve(`${lat.toFixed(6)}, ${lon.toFixed(6)}`);
              }
            }, () => resolve("Lokasi tidak tersedia"));
          } else {
            resolve("Geolocation tidak didukung");
          }
        });
      }

      const startCamera = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
          video.srcObject = stream;
          statusMessageEl.textContent = "Kamera aktif. Posisikan wajah.";
          statusMessageEl.className = "text-green-500 font-semibold mt-2";
        } catch {
          statusMessageEl.textContent = "Gagal mengakses kamera.";
          statusMessageEl.className = "text-red-500 font-semibold mt-2";
        }
      };

      const stopCamera = () => {
        const stream = video.srcObject;
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          video.srcObject = null;
        }
      };

      const takePicture = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL("image/png");
      };

      const submitAttendance = async (dataUrl, nama, lokasi, status) => {
        statusMessageEl.textContent = "‚è≥ Memproses absensi...";
        statusMessageEl.className = "text-blue-500 font-semibold mt-2";
        try {
          await addDoc(collection(db, "absensi"), {
            nama, waktu: serverTimestamp(), lokasi, status, foto: dataUrl
          });
          statusMessageEl.textContent = `‚úÖ Absensi berhasil! ${nama} - ${status}`;
          statusMessageEl.className = "text-green-600 font-semibold mt-2";
          stopCamera();
        } catch {
          statusMessageEl.textContent = "‚ùå Gagal menyimpan absensi.";
          statusMessageEl.className = "text-red-500 font-semibold mt-2";
        }
      };
    };

    window.onload = main;
  </script>
</body>
</html>
